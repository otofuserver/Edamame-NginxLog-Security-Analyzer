# Edamame NginxLog Security Analyzer

## specification.txt バージョン情報
- **specification.txt version**: v1.0.26
- ※このファイルを更新した場合は、必ず上記バージョン情報も更新すること

## 変更履歴
- v1.0.26: 攻撃パターン検出精度の大幅向上とURLデコード機能の強化（2025-07-14）
  - attack_patterns.json: バージョンをv1.2に更新し、攻撃パターンを大幅に強化
    - CommandInjection: rmなど追加コマンドとより多くの演算子（|, &&, ||, ;, $(), ${}など）に対応
    - 新たな攻撃タイプを追加: PathTraversal, LDAP, NoSQL, TemplateInjection
    - SQLi, XSS, LFI, RFI, SSRF, XXE, CSRF, OpenRedirectの検出パターンも改善
  - modules/attack_pattern.py: URLデコード機能を実装し、エンコードされた攻撃も検出可能
    - decode_url関数: 二重エンコーディング・プラスエンコーディングにも対応
    - detect_attack_type関数: 元URLとデコード後URL両方で攻撃パターン検査を実行
    - より正確な正規表現マッチングとフォールバック処理を実装
  - nginx_log_to_mysql.py: URLデコード機能をメイン処理に統合
    - add_registry_entry, add_access_log関数でURLをデコード後に保存
    - エンコード例: %3Cscript%3E → <script> として保存し可読性を向上
  - テスト機能の大幅改善:
    - display_test_results_table関数: テスト結果を詳細なテーブル形式で表示
    - run_comprehensive_test関数: 包括的なテスト実行とクリーンアップを自動化
    - --run-testオプション実行時の自動終了とホス���復帰機能を追加
    - 成功/失敗統計とPASS/FAILステータス表示機能
- v1.0.25: テスト機能に自動クリーンアップ機能を追加（2025-07-14）
  - nginx_log_to_mysql.py: test_attack_detection関数にテスト後の自動クリーンアップ機能を実装
  - テスト成功・失敗・例外発生のすべてのケースでテストデータを確実に削除
  - テスト完了後にurl_registryからテストデータを自動削除し、データベースを清潔に保持
  - 堅牢なエラーハンドリングによりクリーンアップ失敗時も処理を継続
- v1.0.24: rescan_attack_types関数のカーソル処理バグ修正（2025-07-14）
  - nginx_log_to_mysql.py: "Unread result found"エラーを修正
  - cursor.execute()の戻り値誤用を修正し、正しいfetchone()処理に変更
  - MySQLカーソーの仕様に準拠した適切な結果取得処理を実装
  - データベース初期化時のクラッシュを解決
- v1.0.23: テスト機能のデータベース書き込み対応とdescription自動設定（2025-07-14）
  - modules/attack_pattern.py: test_attack_patterns_with_db関数を追加してテストデータのDB書き込み機能を実装
  - テストデータのdescriptionカラムに「【テスト自動追加】」���ーカーと詳細説明を自動設定
  - cleanup_test_data関数を追加してテストデータの自動クリーンアップ機能を実装
  - nginx_log_to_mysql.py: test_attack_detection関数を修正してDB書き込み機能付きテストを実行
  - cleanup_test_attack_data関数を追加してテストデータのクリーンアップ機能を提供
  - テスト用URLは/test/で始まり、6種類の攻撃パターン+正常パターンを含む
- v1.0.22: 自動脅威判定機能の修正と強化（2025-07-14）
  - modules/attack_pattern.py: detect_attack_type関数を完全に書き直し、正規表現マッチングを実装
  - 従来の単純文字列比較から正規表現ベースの攻撃パターン検出に変更
  - 複数攻撃タイプの同時検出に対応（カンマ区切りで返却）
  - JSONの実際の構造に合わせた実装（versionキーを除外）
  - test_attack_patterns関数を追加してデバッグ機能を強化
  - nginx_log_to_mysql.py: rescan_attack_types関数を強化し、変更内容の詳細ログを追加
  - 既存のurl_registryテーブルの攻撃タイプが正常に更新されるように修正
- v1.0.21: URLデコード機能の実装（2025-07-14）
  - modules/log_parser.py: urllib.parse.unquoteを使用したURLデコード機能を追加
  - access_logとurl_registryに保存するURLをデコード後の可読性の高い形式に変更
  - エンコード例: /search?q=%3Cscript%3E → /search?q=<script> に変換
  - デコード失敗時は元の文字列をそのまま保存する安全な実装
- v1.0.20: ファイル監視ログの詳細レベル最適化（2025-07-14）
  - nginx_log_to_mysql.py: ファイルサイズ変化検出、新規ログ処理開始・完了のログレベルをINFOからDEBUGに変更
  - 本番環境での冗長なログ出力を削減し、可読性を向上
  - NGINX_LOG_DEBUG環境変数でデバッグログ制御が可能
- v1.0.19: 真のtail機能を実装し、ファイルポジション維持による効率化（2025-07-10）
  - nginx_log_to_mysql.py: ファイルポジションを維持する真のtail機能を実装
  - 毎回ファイルを最初から読み込む非効率な処理を解決
  - ログローテーション対応とファイル位置の永続化
  - メモリ使用量の削減と処理速度の大幅向上
- v1.0.18: バッチログ処理機能とログ出力最適化（2025-07-10）
  - nginx_log_to_mysql.py: 連続ログ行の自動検出とバッチ処理機能を追加
  - 大量ログ発生時のサマリー表示機能（成功/失敗数の集計表示）
  - 冗長なINFOログ出力を削減し、バッチ処理時は統計情報で表示
  - ログ処理のパフォーマンス向上とコンソール出力の可読性改善
- v1.0.17: デバッグログの制御機能とパフォーマンス最適化（2025-07-10）
  - nginx_log_to_mysql.py: DEBUGレベルログの環境変数制御を追加（NGINX_LOG_DEBUG）
  - 本番環境での可読性向上とログ出力量の最適化
  - ログパーサーの文字化け問題修正を確認・文書化
- v1.0.16: syslog形式のnginxログに対応（2025-07-10）
  - modules/log_parser.py: syslog形式の正規表現パターンを最優先で追加
  - dockerコンテナ環境でのsyslogヘッダー付きログに対応
  - パターン別デバッグ機能を強化（使用したパターン名を表示）
- v1.0.15: access_logのip_addressに「Jul」が挿入されるバグを修正（2025-07-10）
  - modules/log_parser.py: 厳密なIPアドレスパターンと妥当性検証機能を追加
  - IPv4/IPv6アドレスの形式チェック強化
  - 月名やその他無効な文字列の挿入を防止
- v1.0.14: 新規ログ読み込み問題の詳細デバッグ機能を追加（2025-07-10）
  - modules/log_parser.py: デバッグログ��御、重要情報のみINFOレベル出力
  - nginx_log_to_mysql.py: ファイルサイズ変化検出、詳細監視レポート機能
  - 新規ログ検出時の明確な表示（★マーク）、処理結果の詳細ログ
- v1.0.13: 新規ログが読み込まれないバグを修正（2025-07-10）
  - nginx_log_to_mysql.py: tail_log関数の既存ログ処理と新規ログ監視を分離
  - 初期処理後の新規ログ検出機能を改善
  - 新規ログ処理の詳細ログ出力を追加
- v1.0.12: nginxログ読み込み問題の修正とログパーサー改善（2025-07-10）
  - modules/log_parser.py: 複数ログ形式対応、柔軟な正規表現、詳細デバッグ機能
  - nginx_log_to_mysql.py: tail_log関数の強化、エラーハンドリング改善
  - ファイル存在・権限チェック、進捗表示機能を追加
- v1.0.11: モジュールインポートエラーの修正とmodules/__init__.pyの追加（2025-07-10）
  - modules/__init__.py: Pythonパッケージ化による参照解決
  - nginx_log_to_mysql.py: インポート文の修正とエラーハンドリング強化
  - 前任者の不完全な移行作業の完了
- v1.0.10: コードベース全体のリファクタリング実施（モジュール分割、設定集約）（2025-07-09）
  - modules/config.py: 設定値・定数を集約
  - modules/log_parser.py: ログパース処理を分離
  - その他モジュール構造の最適化
- v1.0.8: attack_patterns.jsonにCommandInjection, SSRF, XXE, CSRF, OpenRedirectパターンを追加し、バージョンをv1.1へ更新（2025-07-09）
- v1.0.7: attack_patterns.jsonのバージョン管理をsettingsテーブルから廃止し、GitHubリポジトリから自動バージョン確認・自動更新に変更（2025-07-09）
- v1.0.6: settingsテーブルからfrontend_last_login, frontend_last_ipカラムとその利用を廃止し、ユーザー認証用テーブル（users, login_history）に完全移行（2025-07-09）
- v1.0.5: 文字化け修正（Fernet鍵・環境変数・パーミッション等）（2025-07-03）
- v1.0.4: main関数に型アノテーション追加、関数コメント詳細化、例外処理追加（2025-06-27）
- v1.0.9: users/login_historyテーブル作成・初期ユーザー(admin)自動追加処理をnginx_log_to_mysql.pyからmodules/db_schema.pyへ完全移行（2025-07-09）

## 基本情報
- **アプリ名**: Edamame NginxLog Security Analyzer
- **バージョン**: v1.0.0
- **開発者**: Code Copilot
- **動作環境**:
  - Python 3.11 (Docker環境: python:3.11-slim)
  - MySQL 8.x
  - Linux (Debian/Ubuntuベース)
  - Systemd または Docker コンテナで常駐稼働

---

## 主な機能
### 🔍 1. NGINXログを監視し、MySQLに記録
- `/var/log/nginx/nginx.log` を tail 監視
- `GET/POST/PUT/DELETE` などのアクセスログを抽出し、MySQLに記録
- ログフォーマット例：
  192.168.10.11 - - [21/Jun/2025:23:33:33 +0900] "GET /epgstation/..." 200
- `access_log` テーブルに下記情報を保存:
  - `method`, `full_url`, `status_code`, `ip_address`, `access_time`, `blocked_by_modsec`

### 🛡 2. ModSecurityブロックログの抽出
- ログ内に `ModSecurity: Access denied` を検知
- 該当リクエストが `access_log` に保存された後、その `id` を使って `modsec_alerts` に詳細を記録
- 正規表現で複数ルール (`id`, `msg`, `data`, `severity`) を抽出

### 📦 3. 未登録のURLは `url_registry` に自動登録
- 初回アクセス時に `url_registry` へ追加
- `/run/secrets/attack_patterns.json` を使って `attack_type`（例: SQLi, XSS, LFI等）を識別
- ホワイトリストモード有効かつ指定IPからのアクセスなら `is_whitelisted = TRUE` に

### 🧠 4. `attack_patterns.json` に基づく攻撃タイプ識別
- 起動時に `url_registry` を再スキャンし、`attack_type` を最新に更新
- パターンは `/run/secrets/attack_patterns.json` にJSON形式で定義
- **備考:** `attack_patterns.json` には `"version"` キーが含まれるが、これはシグネチャ判定対象外
- **バージョン管理:** attack_patterns.jsonのバージョンはsettingsテーブルで管理せず、GitHubリポジトリから自動でバージョン確認・更新される
- **主な攻撃タイプ例:** SQLi, XSS, LFI, RFI, CommandInjection, SSRF, XXE, CSRF, OpenRedirect など
- **注意:** バックエンドは外部ネットワークへのバージョン確認は行わない。バージョン確認や更新通知はフロントエンド側で実施すること

---

## データベース構造（MySQL）

### `access_log`
| カラム名         | 型              | 説明                       |
|------------------|------------------|----------------------------|
| id               | INT              | 主キー、自動採番         |
| method           | VARCHAR(10)      | HTTPメソッド              |
| full_url         | TEXT             | アクセスURL（クエリ含む） |
| status_code      | INT              | HTTPステータスコード      |
| ip_address       | VARCHAR(45)      | クライアントIP            |
| access_time      | DATETIME         | アクセス日時（ログから抽出）|
| blocked_by_modsec| BOOLEAN          | ModSecurityブロック有無    |

### `url_registry`
| カラム名         | 型              | 説明                                 |
|------------------|------------------|--------------------------------------|
| id               | INT              | 主キー、自動採番                   |
| method           | VARCHAR(10)      | HTTPメソッド                        |
| full_url         | TEXT             | アクセスURL                         |
| created_at       | DATETIME         | 登録日時（ログから抽出）            |
| updated_at       | DATETIME         | 最終更新日時（ログから抽出）        |
| is_whitelisted   | BOOLEAN          | ホワイトリスト対象か               |
| description      | TEXT             | クライアントによる説明入力欄       |
| attack_type      | VARCHAR(255)     | 識別された攻撃タイプ（複数可）     |
| user_final_threat| BOOLEAN          | ユーザーの脅威最終判断             |
| user_threat_note | TEXT             | 脅威判断に対するメモ欄             |

### `modsec_alerts`
| カラム名         | 型              | 説明                                  |
|------------------|------------------|---------------------------------------|
| id               | INT              | 主キー、自動採番                    |
| access_log_id    | INT              | `access_log.id` への外部キー         |
| rule_id          | VARCHAR(20)      | ModSecurityルールID                  |
| msg              | TEXT             | アラートメッセージ                   |
| data             | TEXT             | 詳細情報                             |
| severity         | VARCHAR(10)      | 深刻度                               |

### `settings`
| カラム名              | 型              | 説明                           |
|------------------------|------------------|----------------------------------|
| id                     | INT              | 固定値: 1（単一レコード管理）   |
| whitelist_mode         | BOOLEAN          | ホワイトリスト有効フラグ       |
| whitelist_ip           | VARCHAR(45)      | 登録用のIPアドレス       |
| backend_version        | VARCHAR(50)      | バックエンドバージョン情報     |
| frontend_version       | VARCHAR(50)      | フロントエンドバージョン情報   |
| attack_patterns_version| VARCHAR(50)      | attack_patterns.jsonバージョン |

### `users`（フロントエンド認証用）
| カラム名         | 型              | 説明                           |
|------------------|------------------|--------------------------------|
| id               | INT              | 主キー、自動採番               |
| username         | VARCHAR(64)      | ユーザー名（ユニーク）         |
| password_hash    | VARCHAR(255)     | パスワード（ハッシュ化）       |
| email            | VARCHAR(255)     | メールアドレス（ユニーク）     |
| is_active        | BOOLEAN          | 有効フラグ                     |
| created_at       | DATETIME         | 作成日時                       |
| updated_at       | DATETIME         | 最終更新日時                   |
| last_login_at    | DATETIME         | 最終ログイン日時               |

#### 🆕 初期ユーザー自動追加仕様
- usersテーブル新規作成時、初期ユーザー（admin/admin123, admin@example.com, is_active=True）を自動追加する。
- パスワードはbcryptでハッシュ化して保存される。
- 本番運用時は初期パスワードを必ず変更すること。

### `login_history`（ログイン履歴）
| カラム名         | 型              | 説明                           |
|------------------|------------------|--------------------------------|
| id               | INT              | 主キー、自動採番               |
| user_id          | INT              | users.id への外部キー           |
| login_ip         | VARCHAR(45)      | ログイン元IP                   |
| login_time       | DATETIME         | ログイン日時                   |
| success          | BOOLEAN          | 成功/失敗フラグ                |
| user_agent       | TEXT             | ユーザーエージェント           |

---

## セキュア設定ファイル（暗号化）

- `setup_secure_config.py` を使用して暗号鍵と接続情報を生成・暗号化
- 生成ファイル：
  - `secret.key`（Fernet鍵）
  - `db_config.enc`（暗号化されたJSON）
- デフォルトの読み取り先： `/run/secrets/`
- **仕様詳細:**
  - `setup_secure_config.py`は対話式ウィザード形式で動作し、MySQL接続情報（ホスト名・ユーザー名・パスワード・DB名）を環境変数またはユーザー入力から取得する。
  - 入力された情報はJSON形式で暗号化され、`db_config.enc`として保存される。
  - 暗号鍵は`secret.key`として保存される。両ファイルともパーミッションは600で作成される。
  - 暗号化・復号にはPython cryptographyパッケージのFernetを使用する。

---

## ログ出力仕様

- ログ出力は`log`関数を通じて行う。
- フォーマットは `[YYYY-MM-DD HH:MM:SS][LEVEL] メッセージ` となる。
- LEVELは "INFO", "WARN", "ERROR", "DB ERROR", "RECOVERED" など用途に応じて付与される。
- ログは標準出力（コンソール）に出力される。

---

## エラー処理・リトライ仕様（DB接続）

- DB接続は`db_connect`関数で行い、最大5回（MAX_RETRIES=5）までリトライする。
- 各リトライ間は3秒（RETRY_DELAY=3）待機する。
- すべてのリトライが失敗した場合はエラーログを出力し、`sys.exit(1)`でプロセスを終了する。
- DB接続失敗時やSQLエラー時は、エラーメッセージをログ出力する。
- DB初期化やテーブル作成時も例外発生時はエラーログを出力し、必要に応じてFalseを返す。

---

## フロントエンド開発者向け情報

### 🔗 API設計方針（想定）
アプリはまだHTTP APIサーバではないが、将来以下の構成を想定：
- `/api/url_registry` GET： 登録された全URL一覧取得（未記入description用）
- `/api/url_registry/:id` PATCH： `description`, `is_whitelisted` の更新
- `/api/access_log` GET： ��アクセス履歴（フィルタ: IP/期間/ブロック有無）
- `/api/modsec_alerts` GET： ブロック詳細一覧
- `/api/settings` GET/PATCH： 全体設定取得・更新

### 🧑‍💻 UI用DB参照ポイント
- **ホワイトリストURL管理**: `url_registry` (`is_whitelisted`, `description`)
- **ModSecurityログ可視化**: `modsec_alerts`, `access_log`
- **ダッシュボード表示**: 日時別件数集計, `attack_type` 分布など

### 📊 推奨グラフビュー
- 時間帯別アクセスグラフ（line chart）
- ModSecurityブロック比率（pie chart）
- 攻撃タイプ別ヒートマップ（heatmap）

---

## 起動・使用方法（Docker）
```bash
docker compose up -d --build
```

コンテナログ確認：
```bash
docker logs -f nginxlog-LO
```

設定ファイル作成：
```bash
python3 setup_secure_config.py
```

---

## 今後の拡張案（予定）
- APIサーバ化（FastAPIなど）
- フロントエンド：React/Next.jsベース管理画面
- 設定のWeb UI化
- CSVエクスポート、Slack通知、GeoIP連携

---

## コーディング・Lint方針

- Pythonの正規表現で [^\]]+ のような \] エスケープは必要です。
  Linter（pycodestyle等）のW605警告は # noqa: W605 で除外してください。
- `MODSEC_RULE_PATTERN` のような [.*?] 形式の正規表現でも、linterのW605警告は # noqa: W605 で除外してください。
- テストやCIでもこの警告は無視して問題ありません。
- ワークフロー（python-test.yml）でもpycodestyle実行時に `--ignore=W605` を指定し、W605警告を除外しています。
- **specification.txtを更新した場合は、必ず冒頭のバージョン情報も更新すること。**
